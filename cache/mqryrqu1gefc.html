<!DOCTYPE html>
<html lang="was" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>opensim:database:asset_cleaner [Wizardry and Steamworks]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="opensim,database,asset_cleaner"/>
<link rel="search" type="application/opensearchdescription+xml" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/opensearch.php" title="Wizardry and Steamworks"/>
<link rel="start" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/"/>
<link rel="contents" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner?do=index" title="Sitemap"/>
<link rel="manifest" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Changes" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/feed.php?mode=list&amp;ns=opensim:database"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/_export/xhtml/opensim/database/asset_cleaner"/>
<link rel="canonical" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner"/>
<link rel="stylesheet" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/css.php?t=was&amp;tseed=24551d22639bdaeb736aec3dca86fd82"/>
<!--[if gte IE 9]><!-->
<script >/*<![CDATA[*/var NS='opensim:database';var JSINFO = {"plugin_imagemap_mldummy":"http:\/\/3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion\/_media\/wiki\/dokuwiki-128.png","isadmin":0,"isauth":0,"plugin_pdfjs":{"hide_download_button":0},"plugins":{"vshare":{"youtube":"youtube\\.com\/.*[&?]v=([a-z0-9_\\-]+)","vimeo":"vimeo\\.com\\\/(\\d+)","slideshare":"slideshare.*id=(\\d+)","dailymotion":"dailymotion\\.com\/video\/([a-z0-9]+)","archiveorg":"archive\\.org\/(?:embed|details)\/([a-zA-Z0-9_\\-]+)","soundcloud":"soundcloud\\.com\/([\\w-]+\/[\\w-]+)","niconico":"nicovideo\\.jp\/watch\/(sm[0-9]+)","bitchute":"bitchute\\.com\\\/video\\\/([a-zA-Z0-9_\\-]+)","coub":"coub\\.com\\\/view\\\/([a-zA-Z0-9_\\-]+)","odysee":"odysee\\.com\/\\$\/(?:embed|download)\/([-%_?=\/a-zA-Z0-9]+)","youku":"v\\.youku\\.com\/v_show\/id_([0-9A-Za-z=]+)\\.html","bilibili":"bilibili\\.com\\\/video\\\/(BV[0-9A-Za-z]+)","msoffice":"(?:office\\.com.*[&?]videoid=([a-z0-9\\-]+))","msstream":"microsoftstream\\.com\\\/video\\\/([a-f0-9\\-]{36})"}},"id":"opensim:database:asset_cleaner","namespace":"opensim:database","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script charset="utf-8" src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/jquery.php?tseed=34a552433bc33cc9c3bc32527289a0b2"></script>
<script charset="utf-8" src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/js.php?t=was&amp;tseed=24551d22639bdaeb736aec3dca86fd82&amp;template=was"></script>
<!--<![endif]-->
    <!-- <link rel="shortcut icon" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/favicon.ico" />
<link rel="apple-touch-icon" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/apple-touch-icon.png" />
 -->
    <!-- Viewport -->
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png?v=2">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png?v=2">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png?v=2">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png?v=2">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png?v=2">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png?v=2">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png?v=2">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png?v=2">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png?v=2">
<link rel="icon" type="image/png" href="/favicon-32x32.png?v=2" sizes="32x32">
<link rel="icon" type="image/png" href="/android-chrome-192x192.png?v=2" sizes="192x192">
<link rel="icon" type="image/png" href="/favicon-96x96.png?v=2" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png?v=2" sizes="16x16">
<link rel="manifest" href="/manifest.json?v=2">
<link rel="shortcut icon" href="/favicon.ico?v=2">
<meta name="apple-mobile-web-app-title" content="[Wizardry and Steamworks]">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/mstile-144x144.png?v=2">
<meta name="application-name" content="[Wizardry and Steamworks]">
<meta name="theme-color" content="#ffffff">
    <!-- <script async type="text/javascript" src="/lib/tpl/was/loadCSS.js"></script>
    <script async type="text/javascript" src="/lib/tpl/was/cssrelpreload.js"></script> -->
</head>

<body>
    <!--[if lte IE 8 ]><div id="IE8"><![endif]-->
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_was     ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header">

	    
	<!-- ********** TOP BAR ********** -->
	<div class="bar" id="bar__top">
		<div class="bar-left" id="bar__topleft">
			<form class="button btn_login" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner"><div class="no"><input type="hidden" name="do" value="login" /><input type="hidden" name="sectok" value="" /><button type="submit" title="Log In">Log In</button></div></form>						<form class="button btn_revs" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner"><div class="no"><input type="hidden" name="do" value="revisions" /><button type="submit" accesskey="o" title="Revisions [O]">Revisions</button></div></form>						<form class="button btn_pdf" action="?do=export_pdf" method="POST">
			    <button type="submit" title="PDF">PDF</button>
                        </form>
		</div>
		<div class="bar-center">
		        <form class="button btn_home" action="/" method="POST">
                            <button type="submit" title="Home">Home</button>
                        </form>
			<form action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" method="get" role="search" class="search doku_form" id="dw__search" accept-charset="utf-8"><input type="hidden" name="do" value="search" /><input type="hidden" name="id" value="opensim:database:asset_cleaner" /><div class="no"><input name="q" type="text" class="edit" title="[F]" accesskey="f" placeholder="Search" autocomplete="on" id="qsearch__in" value="" /><button value="1" type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>			<!-- <form id="osssearchform" method="get" action="renderer">
        <input type="hidden" name="use" value="grimore.org">
        <input type="hidden" name="name" value="default">
        <input type="text" id="osssearchbox" name="query">
        <input type="hidden" name="login" value="search">
        <input type="hidden" name="key" value="1a5f74ab3f4df6ce883c4c158540e25e">
        <input type="submit" value="Search">
</form>
 -->
		</div>
		<div class="bar-right" id="bar__topright">
		        <form class="button btn_contact" action="mailto:%6F%66%66%69%63%65%40%67%72%69%6D%6F%72%65%2E%6F%72%67" method="POST">
			    <button type="submit" title="Contact">Contact</button>
                        </form>
                        <form class="button btn_news" action="/feed.php?type=rss2&amp;ns=opensim:database:asset_cleaner&amp;linkto=page&amp;content=abstract" method="POST">
			    <button type="submit" title="News">News</button>
                        </form>
			<form class="button btn_admin" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner"><div class="no"><input type="hidden" name="do" value="admin" /><button type="submit" title="Admin">Admin</button></div></form>								</div>
			</div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                            <div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" class="wikilink1" title="start" data-wiki-id="start">start</a></bdi></span> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim" class="wikilink1" title="opensim" data-wiki-id="opensim">opensim</a></bdi> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/start" class="wikilink2" title="opensim:database:start" rel="nofollow" data-wiki-id="opensim:database:start">database</a></bdi> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner" class="wikilink1" title="opensim:database:asset_cleaner" data-wiki-id="opensim:database:asset_cleaner">asset_cleaner</a></bdi></div>
                                </div>
    
    <hr class="a11y" />
</div><!-- /header -->

        <div class="wrapper group">

            <!--  -->

            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <!-- <div class="pageId"><span>opensim:database:asset_cleaner</span></div> -->

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc" class="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#introduction">Introduction</a></div></li>
<li class="level1"><div class="li"><a href="#terminology">Terminology</a></div></li>
<li class="level1"><div class="li"><a href="#the_procedure_briefly">The Procedure, Briefly</a></div></li>
<li class="level1"><div class="li"><a href="#step-by-step_guide">Step-by-Step Guide</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#example_run">Example Run</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#contrast_to_alternate_methods_of_asset_handling">Contrast to Alternate Methods of Asset Handling</a></div></li>
<li class="level1"><div class="li"><a href="#further_work">Further Work</a></div></li>
<li class="level1"><div class="li"><a href="#code">Code</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="introduction">Introduction</h1>
<div class="level1">

<p>
One of the major problems of administering OpenSim instances is that users tend to upload assets that may get trashed which eventually end up cluttering the OpenSim MySQL database. OpenSim does not perform a deep-purge like Second Life to identify assets that are unreferenced and remove them from the database. In that sense, an OpenSim database is ever-expanding - once an asset is uploaded, it will never be deleted, regardless whether the uploader deletes the texture along with all the primitives that reference that texture. This is a majorly inconvenient design flaw since assets can stack up quickly on a public grid and incur a considerable performance penalty - making MySQL requests slower and generally slowing down the grid. The procedure described here alleviates the problem of accumulating assets by implementing a deep-purge.
</p>

</div>

<h1 class="sectionedit2" id="terminology">Terminology</h1>
<div class="level1">
<ul>
<li class="level1 node"><div class="li"> An asset can be either a texture, sound or animation that is uploaded onto a grid and receives an UUID. We also expand the notion of basic asset to (currently):</div>
<ul>
<li class="level2"><div class="li"> textures</div>
</li>
<li class="level2"><div class="li"> sounds</div>
</li>
<li class="level2"><div class="li"> clothing</div>
</li>
<li class="level2"><div class="li"> scripts</div>
</li>
<li class="level2"><div class="li"> body parts</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> When an agent uses that asset - for example stamps a texture onto a primitive, that texture becomes referenced. In other words, OpenSim references that uploaded texture by UUID.</div>
</li>
</ul>

<p>
Conversely:
</p>
<ul>
<li class="level1"><div class="li"> We name a live asset, an asset that has been uploaded onto a grid and then used, for example: a texture stamped on a primitive, an animation used for an AO, some clothes in some avatar&#039;s inventory.</div>
</li>
<li class="level1"><div class="li"> We name an orphaned asset, an asset that has at some point been uploaded by an agent (or created, such as clothes), and trashed without being used in-world. Please note that this excludes uploading a texture, stamping it on a primitive and then trashing the texture - this is still considered a live texture.</div>
</li>
</ul>

<p>
And by design, we have that:
</p>
<ul>
<li class="level1"><div class="li"> An OAR and an IAR contains assets that are live. If we were to dump the OARs <em>for all</em> the regions and <em>for all</em> avatars, then the whole contents of the OAR and IAR archives will contain all the assets currently &quot;used&quot; on a grid.</div>
</li>
</ul>

<p>
Thus:
</p>
<ul>
<li class="level1"><div class="li"> Anything that is not present in a full OAR and IAR export of a sever, is considered an orphaned asset<sup><a href="#fn__1" id="fnt__1" class="fn_top">1)</a></sup>.</div>
</li>
</ul>

<p>
In essence, we are doing a set subtraction of assets:
</p>
<ul>
<li class="level1"><div class="li"> The set of orphaned assets is given by the set of all assets in the database minus the set of assets in all the OARs and IARs exported from the console and minus the assets referenced in the scripts in the OARs and IARs exported from the console.</div>
</li>
</ul>

</div>

<h1 class="sectionedit3" id="the_procedure_briefly">The Procedure, Briefly</h1>
<div class="level1">

<p>
The procedure involves dumping the OARs of all the regions, the IARs of all the avatars to different archives. For example, for an OpenSim server with a region called Merlin and one single avatar named Kira, we would have a directory containing:
</p>
<pre class="code">Merlin.oar
Kira.iar</pre>

<p>
Then we add the script from the Code section to the same directory and run:
</p>
<pre class="code bash">php wasAssetCleaner.php Merlin.oar Kira.iar</pre>

<p>
The PHP script will first build a list of all the assets in the database. Then, the PHP script will process the archives (Merlin.oar and Kira.iar) and build a list of assets - these will be considered live assets. The PHP script will also read scripts from the OARs and IARs and look for assets referenced by UUIDs and add them to the list of live assets. After that, the PHP script will delete any assets from the database that are not in the dumped OARs and IARs - effectively wiping out all orphaned assets.
</p>

</div>

<h1 class="sectionedit4" id="step-by-step_guide">Step-by-Step Guide</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> First, create a separate empty directory on your server and copy the script inside it:</div>
</li>
</ul>
<pre class="code bash"><span class="kw2">mkdir</span> clean
<span class="kw3">cd</span> clean</pre>
<ul>
<li class="level1"><div class="li"> Then, edit the script and set the following parameters at the top:</div>
</li>
</ul>
<pre class="code php"><span class="co1">// Hostname or IP of your OpenSim MySQL server.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_HOSTNAME&quot;</span><span class="sy0">,</span> <span class="st0">&quot;localhost&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// Username of the OpenSim MySQL user.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_USERNAME&quot;</span><span class="sy0">,</span> <span class="st0">&quot;opensim&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// Password of the OpenSim MySQL user.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_PASSWORD&quot;</span><span class="sy0">,</span> <span class="st0">&quot;opensim&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// Name of the OpenSim database on the MySQL server.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_DATABASE&quot;</span><span class="sy0">,</span> <span class="st0">&quot;opensim&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
<ul>
<li class="level1"><div class="li"> Next, dump the OARs <em>for all</em> your regions and <em>for all</em> your users into the same directory, so that we have the following files, for example:</div>
</li>
</ul>
<pre class="code">wasAssetCleaner.php 
Kira.iar
Merlin.oar
Rum.oar</pre>

<p>
in one single directly. In this example we have two region OARs: <code>Merlin.oar</code> and <code>Rum.oar</code> and a single user IAR: <code>Kira.iar</code>. 
</p>
<div class="wrap_important wrap_box wrap_round plugin_wrap">
<p>
Make sure that you have dumped <em>all</em> your regions to OARs and <em>all</em> your users to IARs. Any asset that is not in the OARs or IARs will be deleted from the database.  
</p>
</div><ul>
<li class="level1"><div class="li"> Now run the asset cleaner:</div>
</li>
</ul>
<pre class="code bash">wasAssetCleaner.php Kira.iar Merlin.oar Rum.oar</pre>

<p>
you can specify as many IARs and OARs as necessary.
</p>

<p>
This will let you know how many assets will be deleted at each step and ask you to proceed and delete them. After the procedure has completed, restart the server, clear your viewer cache and log-in.
</p>

</div>

<h2 class="sectionedit7" id="example_run">Example Run</h2>
<div class="level2">

<p>
Here is a console dry-run of the tool in action:
</p>
<pre class="code bash"><span class="co4">opensim@opensim.local:~$ </span>php wasAssetCleaner.php Merlin.oar Kira.iar 
<span class="re5">--------------------</span> REMOVE <span class="re5">-----------------</span>
The following assets will be removed : 
bricks 00000000-0000-<span class="nu0">1111</span>-<span class="nu0">9999</span>-000000000001
rocks 00000000-0000-<span class="nu0">1111</span>-<span class="nu0">9999</span>-000000000003
...
From IAR f6773b16-<span class="nu0">2484</span>-4c9e-ae95-359fb67c85d1
Cypress <span class="nu0">1</span> fb2ae204-3fd1-df33-594f-c9f882830e66
<span class="re5">---------------------------------------------</span>
<span class="nu0">172</span> textures will be removed from the database. Are you sure? <span class="br0">&#40;</span>y<span class="sy0">/</span>n<span class="br0">&#41;</span> : n
Bailing out. Nothing was deleted.
<span class="re5">--------------------</span> REMOVE <span class="re5">-----------------</span>
The following assets will be removed : 
UISndPieMenuSliceHighlight3 09b2184e-8601-44e2-afbb-ce37434b8ba1
UISndObjectDelete 0cb7b00a-4c10-<span class="nu0">6948</span>-84de-a93c09af2ba9
...
UISndObjectCreate f4a0660f-<span class="nu0">5446</span>-dea2-80b7-6482a082803c
UISndPieMenuSliceHighlight1 f6ba9816-dcaf-f755-7b67-51b31b6233e5
<span class="nu0">83</span> sounds will be removed from the database. Are you sure? <span class="br0">&#40;</span>y<span class="sy0">/</span>n<span class="br0">&#41;</span> : n
Bailing out. Nothing was deleted.
<span class="re5">--------------------</span> REMOVE <span class="re5">-----------------</span>
The following assets will be removed : 
Shirt 00000000-38f9-<span class="nu0">1111</span>-024e-222222111110
Pants 00000000-38f9-<span class="nu0">1111</span>-024e-222222111120
...
From IAR c98b0dd9-cbd3-4cc4-<span class="nu0">9298</span>-0068efc69d27
From IAR df333523-1e39-488c-a91c-75137029400b
<span class="re5">---------------------------------------------</span>
<span class="nu0">11</span> clothings will be removed from the database. Are you sure? <span class="br0">&#40;</span>y<span class="sy0">/</span>n<span class="br0">&#41;</span> : n
Bailing out. Nothing was deleted.
<span class="re5">--------------------</span> REMOVE <span class="re5">-----------------</span>
The following assets will be removed : 
llBase64ToString 1d4c71d9-b428-11dc-<span class="nu0">8314</span>-0800200c9a66
llSetRot 220baef9-b376-11dc-<span class="nu0">8314</span>-0800200c9a66
From IAR f0b9884b-b0fa-<span class="nu0">4836</span>-8d2e-f20716a73963
From IAR f3903b7c-ad4a-<span class="nu0">4738</span>-9f5a-24258ab469fb
<span class="re5">---------------------------------------------</span>
<span class="nu0">47</span> scripts will be removed from the database. Are you sure? <span class="br0">&#40;</span>y<span class="sy0">/</span>n<span class="br0">&#41;</span> : n
Bailing out. Nothing was deleted.
<span class="re5">--------------------</span> REMOVE <span class="re5">-----------------</span>
The following assets will be removed : 
From IAR 263cad4e-7d5b-4e07-93da-4334c27e3a75
From IAR 2c5589a8-cd3c-c31f-d24b-305963c7dc16
...
From IAR e91a4824-d0b6-<span class="nu0">4784</span>-<span class="nu0">9544</span>-ff68db67ea37
From IAR e9803423-fbe5-42f6-88ec-f988f32be70d
<span class="re5">---------------------------------------------</span>
<span class="nu0">19</span> bodyparts will be removed from the database. Are you sure? <span class="br0">&#40;</span>y<span class="sy0">/</span>n<span class="br0">&#41;</span> : n
Bailing out. Nothing was deleted.
<span class="re5">--------------------</span> REMOVE <span class="re5">-----------------</span>
The following assets will be removed : 
tpose2 01645eeb-8c51-60dc-58cc-b9512f05afc0
...
Handshake ddc2400f-ecdb-b00e-aee7-442ff99d5fb7
From IAR dfa5aca7-b579-4f3b-80fe-54a9100543fd
<span class="re5">---------------------------------------------</span>
<span class="nu0">14</span> animations will be removed from the database. Are you sure? <span class="br0">&#40;</span>y<span class="sy0">/</span>n<span class="br0">&#41;</span> : n
Bailing out. Nothing was deleted.
&nbsp;
All operations completed<span class="sy0">!</span></pre>

<p>
And after answering yes to all questions:
</p>
<pre class="code bash"><span class="co4">opensim@opensim.local:~$ </span>php wasAssetCleaner.php Merlin.oar Kira.iar 
Congratulations<span class="sy0">!</span> Your OpenSim database contains no unreferenced textures.
Congratulations<span class="sy0">!</span> Your OpenSim database contains no unreferenced sounds.
Congratulations<span class="sy0">!</span> Your OpenSim database contains no unreferenced clothings.
Congratulations<span class="sy0">!</span> Your OpenSim database contains no unreferenced scripts.
Congratulations<span class="sy0">!</span> Your OpenSim database contains no unreferenced bodyparts.
Congratulations<span class="sy0">!</span> Your OpenSim database contains no unreferenced animations.
&nbsp;
All operations completed<span class="sy0">!</span></pre>

<p>
Note that the OpenSim injects into the database some default assets - such as the assets you will find in the OpenSim library. It is safe to delete them because they get re-injected when the server is restarted.
</p>

</div>

<h1 class="sectionedit8" id="contrast_to_alternate_methods_of_asset_handling">Contrast to Alternate Methods of Asset Handling</h1>
<div class="level1">

<p>
Note that the problem is not that an avatar uploaded two different identical assets - the problem is that an avatar uploaded one asset and then deleted it. In this case, all of the following do not seem to work at all:
</p>
<ul>
<li class="level1"><div class="li"> An external asset server SRAS is written in ruby for OpenSim that apparently handled de-duplication, compression and others. However it is not exactly clear whether it deletes orphaned assets (recall, orphaned assets are assets that have been uploaded into OpenSim and then the user trashed them). Eliminating duplicates sounds awesome but it still does not solve the issue of orphaned assets.</div>
</li>
<li class="level1"><div class="li"> Hashing. A very simple concept. Hash two identical slices of data and get the same hash. Very useful to eliminate duplicate assets but still does not solve the asset stacking problem.</div>
</li>
<li class="level1"><div class="li"> Recording access times of assets - this is one possible avenue we have considered before writing the script, however what if a user uploads a texture and never uses it? Instead, the avatar keeps the texture around in inventory - or worse, in a primitive. This would never work.</div>
</li>
</ul>

<p>
The conclusion is that the only reliable way of guaranteeing that all the assets are considered is to dump the OARs of all regions and the IARs of all inventories. That gives us a true image of what is contained on a grid.
</p>

</div>

<h1 class="sectionedit9" id="further_work">Further Work</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> <del>The database query performs a lookup on texture assets - since they occupy the most space, however it is possible to expand the script to include all types of assets (TODO).</del> Done.</div>
</li>
<li class="level1"><div class="li"> A fork of this script could effectively delete an user from OpenSim, along with all the assets by querying the <code>CreatorID</code> and wiping all the assets of that avatar - provided that they are not live.</div>
</li>
<li class="level1"><div class="li"> It is further possible to automate this script to make it automatically dump IARs and OARs.</div>
</li>
<li class="level1"><div class="li"> The problem with dumping IARs is that they require the user&#039;s password to be dumped - this is very inconvenient for public grids. There is <a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/server_patches/disable_iar_passwords" class="wikilink1" title="opensim:server_patches:disable_iar_passwords" data-wiki-id="opensim:server_patches:disable_iar_passwords">a patch available</a> that addresses this issue and disables IAR passwords.</div>
</li>
</ul>

</div>

<h1 class="sectionedit10" id="code">Code</h1>
<div class="level1">
<dl class="file">
<dt><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/_export/code/opensim/database/asset_cleaner?codeblock=8" title="Download Snippet" class="mediafile mf_php">wasAssetCleaner.php</a></dt>
<dd><pre class="code file php">#!/usr/bin/php
<span class="kw2">&lt;?php</span>
&nbsp;
<span class="co1">/////////////////////////////////////////////////////////////</span>
<span class="co1">// Wizardry and Steamworks (c) grimore.org - 2013, License: MIT //      </span>
<span class="co1">//                                                         //</span>
<span class="co1">// Permission is hereby granted, free of charge, to any    //</span>
<span class="co1">// person obtaining a copy of this software and associated //</span>
<span class="co1">// documentation files (the &quot;Software&quot;), to deal in the    //</span>
<span class="co1">// Software without restriction, //including without       //</span>
<span class="co1">// limitation the rights to use, copy, modify, merge,      //</span>
<span class="co1">// publish, distribute, sublicense, and/or sell copies of  //</span>
<span class="co1">// the Software, and to permit persons to whom the         //</span>
<span class="co1">// Software is furnished to do so, subject to the          //</span>
<span class="co1">// following conditions:                                   //</span>
<span class="co1">//                                                         //</span>
<span class="co1">// The above copyright notice and this permission notice   //</span>
<span class="co1">// shall be included in all copies or substantial portions //</span>
<span class="co1">// of the Software.                                        //</span>
<span class="co1">//                                                         //</span>
<span class="co1">// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF   //</span>
<span class="co1">// ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT         //</span>
<span class="co1">// LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS   //</span>
<span class="co1">// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO     //</span>
<span class="co1">// EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE  //</span>
<span class="co1">// FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER      //</span>
<span class="co1">// IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING    //</span>
<span class="co1">// FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR      //</span>
<span class="co1">// THE USE OR OTHER DEALINGS IN THE SOFTWARE.              //</span>
<span class="co1">/////////////////////////////////////////////////////////////</span>
&nbsp;
<span class="co1">/////////////////////////////////////////////////////////////</span>
<span class="co1">//                    CONFIGURATION                        //</span>
<span class="co1">/////////////////////////////////////////////////////////////</span>
&nbsp;
<span class="co1">// Hostname or IP of your OpenSim MySQL server.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_HOSTNAME&quot;</span><span class="sy0">,</span> <span class="st0">&quot;localhost&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// Username of the OpenSim MySQL user.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_USERNAME&quot;</span><span class="sy0">,</span> <span class="st0">&quot;opensim&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// Password of the OpenSim MySQL user.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_PASSWORD&quot;</span><span class="sy0">,</span> <span class="st0">&quot;opensim&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// Name of the OpenSim database on the MySQL server.</span>
<a href="http://www.php.net/define"><span class="kw3">define</span></a><span class="br0">&#40;</span><span class="st0">&quot;MYSQL_DATABASE&quot;</span><span class="sy0">,</span> <span class="st0">&quot;opensim&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">/////////////////////////////////////////////////////////////</span>
<span class="co1">//                     INTERNALS                           //</span>
<span class="co1">/////////////////////////////////////////////////////////////</span>
&nbsp;
<span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><a href="http://www.php.net/defined"><span class="kw3">defined</span></a><span class="br0">&#40;</span><span class="st_h">'STDIN'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">print</span> <span class="st_h">'This script is meant to be run on the command line.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$argc</span> <span class="sy0">&lt;</span> <span class="nu0">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">print</span> <span class="st_h">'ERROR: Please specify OARs and IARs to filter on the command line.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">print</span> <span class="st_h">'Syntax: php '</span><span class="sy0">.</span><span class="re0">$argv</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">.</span> <span class="st_h">' &lt;OAR|IAR|...&gt;'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="coMULTI">/*
* Connect to the database and grab all the texture UUIDs
* and store them in an array for later filtering.
*/</span>
<span class="re0">$connection_ok</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_connect"><span class="kw3">mysql_connect</span></a><span class="br0">&#40;</span>MYSQL_HOSTNAME<span class="sy0">,</span> MYSQL_USERNAME<span class="sy0">,</span> MYSQL_PASSWORD<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$connection_ok</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">print</span> <span class="st_h">'Could not connect to the OpenSim database. Please edit the script and make sure the credentials are correct.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="re0">$db_selected</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_select_db"><span class="kw3">mysql_select_db</span></a><span class="br0">&#40;</span>MYSQL_DATABASE<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$db_selected</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">print</span> <span class="st_h">'Could not select the opensim database. Please edit this script and make sure the credentials are correct.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="co1">// Now we can get rid of the script name.</span>
<a href="http://www.php.net/array_shift"><span class="kw3">array_shift</span></a><span class="br0">&#40;</span><span class="re0">$argv</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="coMULTI">/* 
 * First thing to do is search all scripts for references to assets. This will ensure that assets 
 * that are referenced inside scripts and that are deleted from an avatar's inventory or not 
 * displayed in-world will not be deleted from the database.
 */</span> 
<span class="re0">$scriptReferences</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$argv</span> <span class="kw1">as</span> <span class="re0">$arg</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><a href="http://www.php.net/file_exists"><span class="kw3">file_exists</span></a><span class="br0">&#40;</span><span class="re0">$arg</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">print</span> <span class="st_h">'Archive: '</span><span class="sy0">.</span><span class="re0">$arg</span><span class="sy0">.</span><span class="st_h">' does not exist.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="re0">$files</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <a href="http://www.php.net/exec"><span class="kw3">exec</span></a><span class="br0">&#40;</span><span class="st_h">'tar -tzf '</span><span class="sy0">.</span><span class="re0">$arg</span><span class="sy0">.</span><span class="st_h">' 2&gt;/dev/null'</span><span class="sy0">,</span> <span class="re0">$files</span><span class="sy0">,</span> <span class="re0">$ret</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$files</span> <span class="kw1">as</span> <span class="re0">$file</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><a href="http://www.php.net/preg_match"><span class="kw3">preg_match</span></a><span class="br0">&#40;</span><span class="st_h">'/_script/i'</span><span class="sy0">,</span> <span class="re0">$file</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">continue</span><span class="sy0">;</span>
        <span class="re0">$data</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <a href="http://www.php.net/exec"><span class="kw3">exec</span></a><span class="br0">&#40;</span><span class="st_h">'tar -zf '</span><span class="sy0">.</span><span class="re0">$arg</span><span class="sy0">.</span><span class="st_h">' -xO '</span><span class="sy0">.</span><span class="re0">$file</span><span class="sy0">.</span><span class="st_h">' 2&gt;/dev/null'</span><span class="sy0">,</span> <span class="re0">$data</span><span class="sy0">,</span> <span class="re0">$ret</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$ret</span> <span class="sy0">!=</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">print</span> <span class="st_h">'Could not process script: '</span><span class="sy0">.</span><span class="re0">$file</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <a href="http://www.php.net/preg_match_all"><span class="kw3">preg_match_all</span></a><span class="br0">&#40;</span><span class="st0">&quot;/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i&quot;</span><span class="sy0">,</span> <a href="http://www.php.net/implode"><span class="kw3">implode</span></a><span class="br0">&#40;</span><span class="re0">$data</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$referencesInScripts</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$referencesInScripts</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="kw1">as</span> <span class="re0">$uuid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <a href="http://www.php.net/array_push"><span class="kw3">array_push</span></a><span class="br0">&#40;</span><span class="re0">$scriptReferences</span><span class="sy0">,</span> <span class="re0">$uuid</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="coMULTI">/*
 * Now start cleaning assets.
 */</span>
<span class="re0">$assets</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span> <span class="st0">&quot;texture&quot;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="st0">&quot;sound&quot;</span> <span class="sy0">=&gt;</span> <span class="nu0">1</span><span class="sy0">,</span> <span class="st0">&quot;clothing&quot;</span> <span class="sy0">=&gt;</span> <span class="nu0">5</span><span class="sy0">,</span> <span class="st0">&quot;script&quot;</span> <span class="sy0">=&gt;</span> <span class="nu0">10</span><span class="sy0">,</span> <span class="st0">&quot;bodypart&quot;</span> <span class="sy0">=&gt;</span> <span class="nu0">13</span><span class="sy0">,</span> <span class="st0">&quot;animation&quot;</span> <span class="sy0">=&gt;</span> <span class="nu0">20</span> <span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$assets</span> <span class="kw1">as</span> <span class="re0">$assetName</span> <span class="sy0">=&gt;</span> <span class="re0">$assetValue</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="re0">$query</span> <span class="sy0">=</span> <span class="st_h">'SELECT * FROM assets WHERE assetType='</span><span class="sy0">.</span><span class="re0">$assetValue</span><span class="sy0">;</span>
    <span class="re0">$result</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$allAssets</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$row</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_fetch_array"><span class="kw3">mysql_fetch_array</span></a><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <a href="http://www.php.net/array_push"><span class="kw3">array_push</span></a><span class="br0">&#40;</span><span class="re0">$allAssets</span><span class="sy0">,</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'id'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="coMULTI">/*
    * Now grab all the texture UUIDs from the OARs and IARs
    * supplied on the command line for an exclusion list.
    */</span>
    <span class="re0">$liveAssets</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$argv</span> <span class="kw1">as</span> <span class="re0">$arg</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><a href="http://www.php.net/file_exists"><span class="kw3">file_exists</span></a><span class="br0">&#40;</span><span class="re0">$arg</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">print</span> <span class="st_h">'Archive: '</span><span class="sy0">.</span><span class="re0">$arg</span><span class="sy0">.</span><span class="st_h">' does not exist.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="re0">$files</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <a href="http://www.php.net/exec"><span class="kw3">exec</span></a><span class="br0">&#40;</span><span class="st_h">'tar -tzf '</span><span class="sy0">.</span><span class="re0">$arg</span><span class="sy0">.</span><span class="st_h">' 2&gt;/dev/null'</span><span class="sy0">,</span> <span class="re0">$files</span><span class="sy0">,</span> <span class="re0">$ret</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$ret</span> <span class="sy0">!=</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">print</span> <span class="st_h">'Could not process archive: '</span><span class="sy0">.</span><span class="re0">$arg</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
            <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <a href="http://www.php.net/preg_match_all"><span class="kw3">preg_match_all</span></a><span class="br0">&#40;</span><span class="st0">&quot;/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})_<span class="es4">$assetName</span>/i&quot;</span><span class="sy0">,</span> <a href="http://www.php.net/implode"><span class="kw3">implode</span></a><span class="br0">&#40;</span><span class="re0">$files</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$dumpAssets</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$dumpAssets</span><span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="kw1">as</span> <span class="re0">$uuid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <a href="http://www.php.net/array_push"><span class="kw3">array_push</span></a><span class="br0">&#40;</span><span class="re0">$liveAssets</span><span class="sy0">,</span> <span class="re0">$uuid</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="co1">// Now add the script references to the pool.</span>
    <a href="http://www.php.net/array_push"><span class="kw3">array_push</span></a><span class="br0">&#40;</span><span class="re0">$liveAssets</span><span class="sy0">,</span> <span class="re0">$scriptReferences</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*
    * We consider all the assets in the OARs and IARs 
    * supplied on the command line to be live assets.
    * Everything else is considered unreferenced and 
    * orphaned.
    *
    * ORPHANED_ASSETS = (ALL_ASSETS \ LIVE_ASSETS) \ SCRIPT_REFERENCES_TO_ASSETS
    *
    * The same applies to all other asset types.
    */</span>
    <span class="re0">$orphanedAssets</span> <span class="sy0">=</span> <a href="http://www.php.net/array_values"><span class="kw3">array_values</span></a><span class="br0">&#40;</span><a href="http://www.php.net/array_diff"><span class="kw3">array_diff</span></a><span class="br0">&#40;</span><span class="re0">$allAssets</span><span class="sy0">,</span> <span class="re0">$liveAssets</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">if</span><span class="br0">&#40;</span><a href="http://www.php.net/sizeof"><span class="kw3">sizeof</span></a><span class="br0">&#40;</span><span class="re0">$orphanedAssets</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">print</span> <span class="st_h">'Congratulations! Your OpenSim database contains no unreferenced '</span><span class="sy0">.</span><span class="re0">$assetName</span><span class="sy0">.</span><span class="st0">&quot;s.<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw1">continue</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="coMULTI">/*
     * List assets to be deleted.
     */</span>
    <span class="kw1">print</span> <span class="st_h">'-------------------- REMOVE -----------------'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$orphanedAssets</span> <span class="kw1">as</span> <span class="re0">$asset</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$query</span> <span class="sy0">=</span> <span class="st_h">'SELECT * FROM assets WHERE assetType='</span><span class="sy0">.</span><span class="re0">$assetValue</span><span class="sy0">.</span><span class="st_h">' AND id=\''</span><span class="sy0">.</span><span class="re0">$asset</span><span class="sy0">.</span><span class="st_h">'\''</span><span class="sy0">;</span>
        <span class="re0">$result</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">while</span><span class="br0">&#40;</span><span class="re0">$row</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_fetch_array"><span class="kw3">mysql_fetch_array</span></a><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">print</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'name'</span><span class="br0">&#93;</span><span class="sy0">.</span><span class="st_h">' '</span><span class="sy0">.</span><span class="re0">$asset</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">print</span> <span class="st_h">'---------------------------------------------'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*
    * Perform some minor liability dumping. Last chance to quit.
    */</span>
    ASK<span class="sy0">:</span>   
    <span class="kw1">print</span> <a href="http://www.php.net/sizeof"><span class="kw3">sizeof</span></a><span class="br0">&#40;</span><span class="re0">$orphanedAssets</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st_h">' '</span><span class="sy0">.</span><span class="re0">$assetName</span><span class="sy0">.</span><span class="st_h">'s will be removed from the database. Are you sure? (y/n) : '</span><span class="sy0">;</span>
    <span class="re0">$in</span><span class="sy0">=</span><a href="http://www.php.net/trim"><span class="kw3">trim</span></a><span class="br0">&#40;</span><a href="http://www.php.net/fgets"><span class="kw3">fgets</span></a><span class="br0">&#40;</span>STDIN<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$in</span> <span class="sy0">==</span> <span class="st_h">'y'</span><span class="br0">&#41;</span> goto GO<span class="sy0">;</span>
    <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$in</span> <span class="sy0">==</span> <span class="st_h">'n'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">print</span> <span class="st_h">'Bailing out. Nothing was deleted.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
        <span class="kw1">continue</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">print</span> <span class="st_h">'Please type either y to proceed or n to quit without deleting anything.'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    goto ASK<span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*
    * Start to delete unreferenced assets from the database.
    */</span>
    GO<span class="sy0">:</span>
    <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$orphanedAssets</span> <span class="kw1">as</span> <span class="re0">$uuid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="re0">$query</span> <span class="sy0">=</span> <span class="st_h">'DELETE FROM assets WHERE assetType='</span><span class="sy0">.</span><span class="re0">$assetValue</span><span class="sy0">.</span><span class="st_h">' AND id=\''</span><span class="sy0">.</span><span class="re0">$uuid</span><span class="sy0">.</span><span class="st_h">'\''</span><span class="sy0">;</span>
        <span class="re0">$result</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="re0">$query</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$result</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">print</span> <span class="st_h">'-'</span><span class="sy0">;</span>
            <span class="kw1">continue</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">print</span> <span class="st_h">'e'</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">print</span> <span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">print</span> <span class="st_h">'Finished deleting '</span><span class="sy0">.</span><span class="re0">$assetName</span><span class="sy0">.</span><span class="st0">&quot;s.<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">print</span> <span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw1">print</span> <span class="st_h">'All operations completed!'</span><span class="sy0">.</span><span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
&nbsp;
<span class="sy1">?&gt;</span></pre>
</dd></dl>

</div>
<div class="footnotes">
<div class="fn"><sup><a href="#fnt__1" id="fn__1" class="fn_bot">1)</a></sup> 
<div class="content">However, it is possible that an asset is referenced inside the script, so we must also search scripts within OARs and IARs for references to assets and not delete them.</div></div>
</div>

                    <!-- wikipage stop -->
                                    </div>

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <div class="docInfo"><bdi>opensim/database/asset_cleaner.txt</bdi> · Last modified: 2022/04/19 09:28 (external edit)</div>

            <!-- PAGE ACTIONS -->
            <!-- <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Revisions [O]"><span>Revisions</span></a></li><li><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner?do=backlink"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner?do=export_pdf"  class="action export_pdf" rel="nofollow" title="Export to PDF"><span>Export to PDF</span></a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div>--><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer">
    <!-- <div class="buttons">
                <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://www.php.net" title="Powered by PHP" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div> -->

		<!-- BREADCRUMBS -->
					<div class="breadcrumbs">
									<div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" class="wikilink1" title="start" data-wiki-id="start">start</a></bdi></span> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim" class="wikilink1" title="opensim" data-wiki-id="opensim">opensim</a></bdi> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/start" class="wikilink2" title="opensim:database:start" rel="nofollow" data-wiki-id="opensim:database:start">database</a></bdi> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner" class="wikilink1" title="opensim:database:asset_cleaner" data-wiki-id="opensim:database:asset_cleaner">asset_cleaner</a></bdi></div>
											</div>
		
		<!-- ********** BOTTOM BAR ********** -->
		<div class="bar" id="bar__bottom">
		  <div class="bar-left" id="bar__bottomleft">
			<form class="button btn_login" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner"><div class="no"><input type="hidden" name="do" value="login" /><input type="hidden" name="sectok" value="" /><button type="submit" title="Log In">Log In</button></div></form>						<form class="button btn_revs" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner"><div class="no"><input type="hidden" name="do" value="revisions" /><button type="submit" accesskey="o" title="Revisions [O]">Revisions</button></div></form>			                        <form class="button btn_pdf" action="?do=export_pdf" method="POST">
                            <button type="submit" title="PDF">PDF</button>
                        </form>
		  </div>
		  <div class="bar-center">
                        <form class="button btn_home" action="/" method="POST">
                            <button type="submit" title="Home">Home</button>
                        </form>
			<form action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" method="get" role="search" class="search doku_form" id="dw__search" accept-charset="utf-8"><input type="hidden" name="do" value="search" /><input type="hidden" name="id" value="opensim:database:asset_cleaner" /><div class="no"><input name="q" type="text" class="edit" title="[F]" accesskey="f" placeholder="Search" autocomplete="on" id="qsearch__in" value="" /><button value="1" type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>			<!-- <form id="osssearchform" method="get" action="renderer">
        <input type="hidden" name="use" value="grimore.org">
        <input type="hidden" name="name" value="default">
        <input type="text" id="osssearchbox" name="query">
        <input type="hidden" name="login" value="search">
        <input type="hidden" name="key" value="1a5f74ab3f4df6ce883c4c158540e25e">
        <input type="submit" value="Search">
</form>
 -->
		  </div>
		  <div class="bar-right" id="bar__bottomright">
                        <form class="button btn_contact" action="mailto:%6F%66%66%69%63%65%40%67%72%69%6D%6F%72%65%2E%6F%72%67" method="POST">
                            <button type="submit" title="Contact">Contact</button>
                        </form>
                        <form class="button btn_news" action="/feed.php?mode=recent&amp;type=rss" method="POST">
                            <button type="submit" title="News">News</button>
                        </form>
			<form class="button btn_admin" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/opensim/database/asset_cleaner"><div class="no"><input type="hidden" name="do" value="admin" /><button type="submit" title="Admin">Admin</button></div></form>								  </div>
		  		</div>

		
</div><!-- /footer -->

<div style="text-align: center;">
    <div style="display:inline-block;">
      <p>
        <a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion">
          <img src="/lib/tpl/was/images/button-tor.png" alt="Access website using Tor" />
        </a> 
        <a href="http://ioujrf2uwqairs7l3vyvqp7n2pia3x3wg5w5qtcqvg32zezuezza.b32.i2p/" />
          <img src="/lib/tpl/was/images/button-i2p.png" alt="Access website using i2p" />
        </a>
        <a href="http://pgp.grimore.org/" />
          <img src="/lib/tpl/was/images/button-pgp.png" alt="Wizardry and Steamworks PGP Key" />
        </a>
      </p>
    </div>
<!--    <div style="display:inline-block;">
      <p>
        <a href="http://ij4lpzuyyng6cc4jw5mxibcyjv4rx4uk6x5jijoduglkgjh7mmya.b32.i2p">
          <img src="/lib/tpl/was/images/button-i2p.png" alt="Access website using i2p" />
        </a> 
      </p>
    </div>
    <div style="display:inline-block;">
      <p>
        <a href="http://cydia.grimore.org/">
          <img src="/lib/tpl/was/images/button-cydia.png" alt="Wizardry and Steamworks Cydia Repository" />
        </a> 
      </p>
    </div>
    <div style="display:inline-block;">
      <p>
        <a href="http://debian.grimore.org/">
          <img src="/lib/tpl/was/images/button-debian.png" alt="Wizardry and Steamworks Debian Repository" />
        </a> 
      </p>
    </div>
    <div style="display:inline-block;">
      <p>
        <a href="/opt/pasteboard/" rel="external nofollow">
          <img src="/lib/tpl/was/images/button-live.png" alt="Live Pasteboard" />
        </a> 
      </p>
    </div> -->
    
<br/>

    <p>
      For the copyright, license, warranty and privacy terms for the usage of this website please see the <a
      href="/wiki:license">license</a>, <a href="/wiki:privacy">privacy</a>, <a
      href="/wiki:copyright">copyright</a>
      and the <a href="/wiki:plagiarism">plagiarism</a> pages.
    </p>
</div>
    </div></div><!-- /site -->

    <div class="no"><img src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/taskrunner.php?id=opensim%3Adatabase%3Aasset_cleaner&amp;1657308054" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div>    <!--[if lte IE 8 ]></div><![endif]-->
</body>
</html>
