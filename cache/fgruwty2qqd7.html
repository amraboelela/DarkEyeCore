<!DOCTYPE html>
<html lang="was" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>fuss:raspberry_pi [Wizardry and Steamworks]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="fuss,raspberry_pi"/>
<link rel="search" type="application/opensearchdescription+xml" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/opensearch.php" title="Wizardry and Steamworks"/>
<link rel="start" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/"/>
<link rel="contents" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi?do=index" title="Sitemap"/>
<link rel="manifest" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/manifest.php"/>
<link rel="alternate" type="application/rss+xml" title="Changes" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/feed.php?mode=list&amp;ns=fuss"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/_export/xhtml/fuss/raspberry_pi"/>
<link rel="canonical" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi"/>
<link rel="stylesheet" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/css.php?t=was&amp;tseed=24551d22639bdaeb736aec3dca86fd82"/>
<!--[if gte IE 9]><!-->
<script >/*<![CDATA[*/var NS='fuss';var JSINFO = {"plugin_imagemap_mldummy":"http:\/\/3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion\/_media\/wiki\/dokuwiki-128.png","isadmin":0,"isauth":0,"plugin_pdfjs":{"hide_download_button":0},"plugins":{"vshare":{"youtube":"youtube\\.com\/.*[&?]v=([a-z0-9_\\-]+)","vimeo":"vimeo\\.com\\\/(\\d+)","slideshare":"slideshare.*id=(\\d+)","dailymotion":"dailymotion\\.com\/video\/([a-z0-9]+)","archiveorg":"archive\\.org\/(?:embed|details)\/([a-zA-Z0-9_\\-]+)","soundcloud":"soundcloud\\.com\/([\\w-]+\/[\\w-]+)","niconico":"nicovideo\\.jp\/watch\/(sm[0-9]+)","bitchute":"bitchute\\.com\\\/video\\\/([a-zA-Z0-9_\\-]+)","coub":"coub\\.com\\\/view\\\/([a-zA-Z0-9_\\-]+)","odysee":"odysee\\.com\/\\$\/(?:embed|download)\/([-%_?=\/a-zA-Z0-9]+)","youku":"v\\.youku\\.com\/v_show\/id_([0-9A-Za-z=]+)\\.html","bilibili":"bilibili\\.com\\\/video\\\/(BV[0-9A-Za-z]+)","msoffice":"(?:office\\.com.*[&?]videoid=([a-z0-9\\-]+))","msstream":"microsoftstream\\.com\\\/video\\\/([a-f0-9\\-]{36})"}},"id":"fuss:raspberry_pi","namespace":"fuss","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script charset="utf-8" src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/jquery.php?tseed=34a552433bc33cc9c3bc32527289a0b2"></script>
<script charset="utf-8" src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/js.php?t=was&amp;tseed=24551d22639bdaeb736aec3dca86fd82&amp;template=was"></script>
<!--<![endif]-->
    <!-- <link rel="shortcut icon" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/favicon.ico" />
<link rel="apple-touch-icon" href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/apple-touch-icon.png" />
 -->
    <!-- Viewport -->
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png?v=2">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png?v=2">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png?v=2">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png?v=2">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png?v=2">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png?v=2">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png?v=2">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png?v=2">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png?v=2">
<link rel="icon" type="image/png" href="/favicon-32x32.png?v=2" sizes="32x32">
<link rel="icon" type="image/png" href="/android-chrome-192x192.png?v=2" sizes="192x192">
<link rel="icon" type="image/png" href="/favicon-96x96.png?v=2" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png?v=2" sizes="16x16">
<link rel="manifest" href="/manifest.json?v=2">
<link rel="shortcut icon" href="/favicon.ico?v=2">
<meta name="apple-mobile-web-app-title" content="[Wizardry and Steamworks]">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/mstile-144x144.png?v=2">
<meta name="application-name" content="[Wizardry and Steamworks]">
<meta name="theme-color" content="#ffffff">
    <!-- <script async type="text/javascript" src="/lib/tpl/was/loadCSS.js"></script>
    <script async type="text/javascript" src="/lib/tpl/was/cssrelpreload.js"></script> -->
</head>

<body>
    <!--[if lte IE 8 ]><div id="IE8"><![endif]-->
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_was     ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header">

	    
	<!-- ********** TOP BAR ********** -->
	<div class="bar" id="bar__top">
		<div class="bar-left" id="bar__topleft">
			<form class="button btn_login" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi"><div class="no"><input type="hidden" name="do" value="login" /><input type="hidden" name="sectok" value="" /><button type="submit" title="Log In">Log In</button></div></form>						<form class="button btn_revs" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi"><div class="no"><input type="hidden" name="do" value="revisions" /><button type="submit" accesskey="o" title="Revisions [O]">Revisions</button></div></form>						<form class="button btn_pdf" action="?do=export_pdf" method="POST">
			    <button type="submit" title="PDF">PDF</button>
                        </form>
		</div>
		<div class="bar-center">
		        <form class="button btn_home" action="/" method="POST">
                            <button type="submit" title="Home">Home</button>
                        </form>
			<form action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" method="get" role="search" class="search doku_form" id="dw__search" accept-charset="utf-8"><input type="hidden" name="do" value="search" /><input type="hidden" name="id" value="fuss:raspberry_pi" /><div class="no"><input name="q" type="text" class="edit" title="[F]" accesskey="f" placeholder="Search" autocomplete="on" id="qsearch__in" value="" /><button value="1" type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>			<!-- <form id="osssearchform" method="get" action="renderer">
        <input type="hidden" name="use" value="grimore.org">
        <input type="hidden" name="name" value="default">
        <input type="text" id="osssearchbox" name="query">
        <input type="hidden" name="login" value="search">
        <input type="hidden" name="key" value="1a5f74ab3f4df6ce883c4c158540e25e">
        <input type="submit" value="Search">
</form>
 -->
		</div>
		<div class="bar-right" id="bar__topright">
		        <form class="button btn_contact" action="mailto:%6F%66%66%69%63%65%40%67%72%69%6D%6F%72%65%2E%6F%72%67" method="POST">
			    <button type="submit" title="Contact">Contact</button>
                        </form>
                        <form class="button btn_news" action="/feed.php?type=rss2&amp;ns=fuss:raspberry_pi&amp;linkto=page&amp;content=abstract" method="POST">
			    <button type="submit" title="News">News</button>
                        </form>
			<form class="button btn_admin" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi"><div class="no"><input type="hidden" name="do" value="admin" /><button type="submit" title="Admin">Admin</button></div></form>								</div>
			</div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                            <div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" class="wikilink1" title="start" data-wiki-id="start">start</a></bdi></span> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss" class="wikilink1" title="fuss" data-wiki-id="fuss">fuss</a></bdi> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi" class="wikilink1" title="fuss:raspberry_pi" data-wiki-id="fuss:raspberry_pi">raspberry_pi</a></bdi></div>
                                </div>
    
    <hr class="a11y" />
</div><!-- /header -->

        <div class="wrapper group">

            <!--  -->

            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <!-- <div class="pageId"><span>fuss:raspberry_pi</span></div> -->

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc" class="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#enable_uart_serial_communication">Enable UART Serial Communication</a></div></li>
<li class="level1"><div class="li"><a href="#disable_wifi_power_management">Disable Wifi Power Management</a></div></li>
<li class="level1"><div class="li"><a href="#enable_ssh_on_first_boot">Enable SSH on (First) Boot</a></div></li>
<li class="level1"><div class="li"><a href="#check_if_hardware_decoders_are_enabled">Check if Hardware Decoders are Enabled</a></div></li>
<li class="level1"><div class="li"><a href="#change_audio_output">Change Audio Output</a></div></li>
<li class="level1"><div class="li"><a href="#logging-in_via_ssh_over_usb">Logging-in via SSH over USB</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#connecting_to_a_bridge_automatically">Connecting to a Bridge Automatically</a></div></li>
<li class="level2"><div class="li"><a href="#restoring_for_normal_usb_operation">Restoring for Normal USB Operation</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#enabling_monitor_mode_via_nexmon_drivers">Enabling Monitor Mode via Nexmon Drivers</a></div></li>
<li class="level1"><div class="li"><a href="#running_a_one-off_script_on_first_machine_boot">Running a One-Off Script on First Machine Boot</a></div></li>
<li class="level1"><div class="li"><a href="#downgrade_or_upgrade_to_specific_kernel_version">Downgrade or Upgrade to Specific Kernel Version</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#downgrade_to_last_stable_firmware">Downgrade to Last Stable Firmware</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#fixing_a_blinking_monitor">Fixing a Blinking Monitor</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#simultaneously_playing_audio_through_headphones_analog_and_hdmi_digital">Simultaneously Playing Audio through Headphones (analog) and HDMI (digital)</a></div></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="enable_uart_serial_communication">Enable UART Serial Communication</h1>
<div class="level1">

<p>
Edit <code>/boot/config.txt</code> and append:
</p>
<pre class="code">enable_uart=1</pre>

<p>
to the end of the file and reboot.
</p>

</div>

<h1 class="sectionedit2" id="disable_wifi_power_management">Disable Wifi Power Management</h1>
<div class="level1">

<p>
When receiving large amounts of output over SSH the Raspberry Pi might render the console inoperable and the connection will time out in a few seconds.
</p>

<p>
The following command adds some module options to the wifi kernel module to disable power management which is apparently responsible for the former issue.
</p>
<pre class="code">echo &quot;options 8192cu rtw_power_mgnt=0 rtw_enusbss=0&quot; | sudo tee --append /etc/modprobe.d/8192cu.conf</pre>

</div>

<h1 class="sectionedit3" id="enable_ssh_on_first_boot">Enable SSH on (First) Boot</h1>
<div class="level1">

<p>
Create a blank file named <code>ssh</code> with no extension at the root of the boot partition of the SD card in order to make Raspbian start the SSH daemon on boot. One use for this trick is combining the Raspberry Pi with an ethernet hat such that the Raspberry can be setup without needing to attach a monitor and keyboard.
</p>

</div>

<h1 class="sectionedit4" id="check_if_hardware_decoders_are_enabled">Check if Hardware Decoders are Enabled</h1>
<div class="level1">
<pre class="code">vcgencmd codec_enabled MPG2
vcgencmd codec_enabled WVC1</pre>

<p>
Note that the Raspberry Pi 4 does not have hardware decoders such that the commands will most likely state <code>disabled</code>.
</p>

</div>

<h1 class="sectionedit5" id="change_audio_output">Change Audio Output</h1>
<div class="level1">

<p>
Issuing:
</p>
<pre class="code bash">amixer controls</pre>

<p>
will yield the controls available on the Raspberry Pi:
</p>
<pre class="code bash"><span class="co0"># amixer controls</span>
<span class="re2">numid</span>=<span class="nu0">3</span>,<span class="re2">iface</span>=MIXER,<span class="re2">name</span>=<span class="st_h">'PCM Playback Route'</span>
<span class="re2">numid</span>=<span class="nu0">2</span>,<span class="re2">iface</span>=MIXER,<span class="re2">name</span>=<span class="st_h">'PCM Playback Switch'</span>
<span class="re2">numid</span>=<span class="nu0">1</span>,<span class="re2">iface</span>=MIXER,<span class="re2">name</span>=<span class="st_h">'PCM Playback Volume'</span></pre>

<p>
The Raspberry Pi 2,3 and 4 can commute between sending sound through the <img src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/fetch.php?media=wiki:latex:/img2cb98e12dc9ecd65402486a8b4eba284.png" class="latex_inline" alt="$3.5mm$" title="Math" /> audio jack:
</p>
<pre class="code bash">amixer cset <span class="re2">numid</span>=<span class="nu0">3</span> <span class="nu0">1</span></pre>

<p>
or the HDMI output:
</p>
<pre class="code bash">amixer cset <span class="re2">numid</span>=<span class="nu0">3</span> <span class="nu0">2</span></pre>

<p>
respectively, or:
</p>
<pre class="code bash">amixer cset <span class="re2">numid</span>=<span class="nu0">3</span></pre>

<p>
to set the sound selection to autodetect where the jack will be used only if the HDMI cable is not connected.
</p>

</div>

<h1 class="sectionedit6" id="logging-in_via_ssh_over_usb">Logging-in via SSH over USB</h1>
<div class="level1">

<p>
The Raspberry Pi when connected to a PC can configure itself as an USB gadget and start a network over USB. A RNDIS network adapter is needed in most cases and can be downloaded from here:
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/_media/fuss/fuss_raspberry_pi_rndis_driver.zip" class="media mediafile mf_zip" title="fuss:fuss_raspberry_pi_rndis_driver.zip (5.9 KB)">RNDIS.zip</a></div>
</li>
</ul>

<p>
In order to log into the Raspberry Pi over SSH via the USB port, edit <code>config.txt</code> and add:
</p>
<pre class="code">dtoverlay=dwc2</pre>

<p>
Next, edit <code>cmdline.txt</code> and add the following to the kernel parameters between <code>rootwait</code> and <code>quiet</code>:
</p>
<pre class="code">modules-load=dwc2,g_ether</pre>

<p>
Finally, add a blank file named <code>ssh</code> with no contents to the root of the <code>boot</code> partition.
</p>

<p>
The Raspberry can now be connected to a PC via its USB port (not the USB port marked <code>PWR</code>). The PC that the Raspberry Pi connects to will act as a router and should forward packets to the Raspberry Pi. 
</p>

<p>
When the RNDIS interface is brought up, if Apple bonjour is installed and running on the machine that the Raspberry Pi is connected to, then the Raspberry Pi is supposed to register the DNS address <code>raspberry.local</code> via mDNS with Windows. Even if Apple bonjour is installed, the name might not be assigned even though the Rasbperry Pi might be configured properly as per the above. Also, it seems that in some cases when the RNDIS interface is brought up, the Raspberry Pi does not send any packets as all making an ARP table query via <code>arp -a</code> entirely futile.
</p>

<p>
The first attempt would be to try connecting via the assigned DNS address: <code>ssh pi@raspberry.local</code> and enter <code>raspberry</code> at the password prompt. if that fails, a packet sniffer such as WireShark or TcpDump may reveal the initial Raspberry Pi&#039;s ARP requests for Google&#039;s DNS servers (<code>8.8.8.8</code>). Sometimes just restarting the bonjour service and disabling and re-enabling the RNDIS interface may get the Raspberry Pi to register its name.
</p>

</div>

<h2 class="sectionedit7" id="connecting_to_a_bridge_automatically">Connecting to a Bridge Automatically</h2>
<div class="level2">

<p>
In order to connect the Raspberry Pi to a bridge as it is connected to a server, <a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/linux#automatically_add_all_rndis_devices_to_a_bridge" class="wikilink1" title="fuss:linux" data-wiki-id="fuss:linux">an udev rule can be written</a> that will match all RNDIS adapters and connect them to a bridge.
</p>

<p>
The only changes required on the Raspberry Pi is to edit <code>/etc/network/interfaces.d/usb0</code> and add the lines:
</p>
<pre class="code">auto usb0
iface usb0 inet dhcp</pre>

<p>
and save the file. This will make sure that when the Raspberry Pi boots, an IP address will be requested over the <code>usb0</code> interface and will work provided that the computer that the Raspberry Pi is connected to is running a DHCP server on the other end.
</p>

</div>

<h2 class="sectionedit8" id="restoring_for_normal_usb_operation">Restoring for Normal USB Operation</h2>
<div class="level2">

<p>
After configuring, the USB port makes the Raspberry Pi act like a gadget device and in order to connect regular USB hardware, the configuration has to be altered. Edit <code>/boot/cmdline.txt</code> and <code>/boot/config.txt</code> to remove the previous changes and reboot. Devices should connect normally now and should be recognized.
</p>

</div>

<h1 class="sectionedit9" id="enabling_monitor_mode_via_nexmon_drivers">Enabling Monitor Mode via Nexmon Drivers</h1>
<div class="level1">

<p>
Some Raspberry Pi devices such as the Raspberry Pi Zero W can operate in monitor mode in order to sniff wireless traffic. Up to this date, there is no official way to get monitor mode working for the Raspberry SoC except for using alternative Nexmon drivers that replace the <code>brcmfmac</code> kernel module with a patched module enabling monitor mode. Unfortunately, the Nexmon drivers lag behind and last successful builds are known to work with Raspbian Jessie at best.
</p>

<p>
Here is a short guide on how to build the nexmon drivers for Raspberry Pi W and substitute the kernel module in order to enable monitor mode.
</p>

<p>
Install required packages to compile the drivers:
</p>
<pre class="code bash"><span class="kw2">apt-get install</span> subversion raspberrypi-kernel-headers <span class="kw2">git</span> libgmp3-dev <span class="kw2">gawk</span> qpdf <span class="kw2">bison</span> <span class="kw2">flex</span> <span class="kw2">make</span> <span class="kw2">autoconf</span> <span class="kw2">automake</span> build-essential libtool libisl10</pre>

<p>
Change directory to a compile space:
</p>
<pre class="code bash"><span class="kw3">cd</span> <span class="sy0">/</span>usr<span class="sy0">/</span>src</pre>

<p>
and check out the source (official):
</p>
<pre class="code bash"><span class="kw2">git clone</span> https:<span class="sy0">//</span>github.com<span class="sy0">/</span>MaximusBaton<span class="sy0">/</span>nexmon.git</pre>

<p>
or from Wizardry and Steamworks:
</p>
<pre class="code bash"><span class="kw2">svn co</span> http:<span class="sy0">//</span>svn.grimore.org<span class="sy0">/</span>nexmon</pre>

<p>
Set variables:
</p>
<pre class="code bash"><span class="kw3">export</span> <span class="re2">NEXMON_ROOT</span>=<span class="sy0">/</span>usr<span class="sy0">/</span>src<span class="sy0">/</span>nexmon</pre>

<p>
and load the provided environment:
</p>
<pre class="code bash"><span class="kw3">source</span> setup_env.sh</pre>

<p>
Now compile the nexmon package from the top-level:
</p>
<pre class="code bash"><span class="kw2">make</span></pre>

<p>
Now build the kernel module and firmware:
</p>
<pre class="code bash"><span class="kw3">cd</span> patches<span class="sy0">/</span>bcm43430a1<span class="sy0">/</span><span class="nu0">7</span>_45_41_46<span class="sy0">/</span>nexmon<span class="sy0">/</span></pre>

<p>
where:
</p>
<ul>
<li class="level1"><div class="li"> <code>bcm43430a1</code> is for the Raspberry Pi Zero W</div>
</li>
</ul>
<pre class="code bash"><span class="kw2">make</span></pre>

<p>
Now generate a backup of the original firmware file and install the patched firmware:
</p>
<pre class="code bash"><span class="kw2">make</span> backup-firmware
<span class="kw2">make</span> install-firmware</pre>

<p>
Compile <code>nexutil</code> since it might come in handy:
</p>
<pre class="code bash"><span class="kw3">cd</span> utilities<span class="sy0">/</span>nexutil
<span class="kw2">make</span> <span class="kw2">install</span></pre>

<p>
Now to make the Raspberry load the modified kernel module after reboot it, the existing module is simply substituted for the module that was compiled at the previous step:
</p>
<pre class="code bash"><span class="re2">PATH_OF_DEFAULT_DRIVER_AT_REBOOT</span>=$<span class="br0">&#40;</span>modinfo brcmfmac <span class="sy0">|</span> <span class="kw2">grep</span> <span class="re5">-m</span> <span class="nu0">1</span> <span class="re5">-oP</span> <span class="st0">&quot;^filename:(\s*?)(.*)$&quot;</span> <span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st_h">'s/^filename:\(\s*\)\(.*\)$/\2/g'</span><span class="br0">&#41;</span>
<span class="kw2">mv</span> <span class="st0">&quot;<span class="es2">$PATH_OF_DEFAULT_DRIVER_AT_REBOOT</span>&quot;</span> <span class="st0">&quot;<span class="es2">$PATH_OF_DEFAULT_DRIVER_AT_REBOOT</span>.orig&quot;</span>
<span class="kw2">cp</span> patches<span class="sy0">/</span>bcm43430a1<span class="sy0">/</span><span class="nu0">7</span>_45_41_46<span class="sy0">/</span>nexmon<span class="sy0">/</span>brcmfmac_4.14.y-nexmon<span class="sy0">/</span>brcmfmac.ko <span class="re1">$PATH_OF_DEFAULT_DRIVER_AT_REBOOT</span></pre>

<p>
Finally, generate module dependencies:
</p>
<pre class="code bash"><span class="kw2">depmod</span> <span class="re5">-a</span></pre>

<p>
In order to set up the Wifi monitoring interface on boot, create the file  <code>/etc/network/interfaces.d/mon0</code> with the following contents:
</p>
<pre class="code">auto mon0
iface mon0 inet manual
  pre-up iw wlan0 interface add mon0 type monitor
  wireless-mode monitor
</pre>

<p>
and restart the Raspberry Pi.
</p>

</div>

<h1 class="sectionedit10" id="running_a_one-off_script_on_first_machine_boot">Running a One-Off Script on First Machine Boot</h1>
<div class="level1">

<p>
To execute a script unconditionally edit <code>/boot/cmdline.txt</code> and set <code>init</code> to mount virtual filesystems and then execute a script. For example, the <code>/boot/cmdline.txt</code> file would contain:
</p>
<pre class="code">init=/bin/bash -- -c &quot;mount -t proc proc /proc; mount -t sysfs sys /sys; mount /boot; source /boot/firstboot.sh&quot;</pre>

<p>
that will end up executing <code>/boot/firstboot.sh</code>.
</p>

<p>
The contents of <code>/boot/firstboot.sh</code> should make sure to remove the <code>init</code> parameter from the kernel command line such that the first boot script does not run again, then perform the necessary operations and finally restart the system:
</p>
<pre class="code bash"><span class="co0"># Boot</span>
<span class="kw2">mount</span> <span class="re5">-t</span> tmpfs tmp <span class="sy0">/</span>run
<span class="kw2">mkdir</span> <span class="re5">-p</span> <span class="sy0">/</span>run<span class="sy0">/</span>systemd
<span class="kw2">mount</span> <span class="sy0">/</span> <span class="re5">-o</span> remount,rw
<span class="co0"># Ensure the script does not run again.</span>
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="st_h">'s| init=.*||'</span> <span class="sy0">/</span>boot<span class="sy0">/</span>cmdline.txt
&nbsp;
<span class="co0"># Run</span>
&nbsp;
<span class="co0"># Insert custom commands.</span>
<span class="sy0">/</span>usr<span class="sy0">/</span>lib<span class="sy0">/</span>raspi-config<span class="sy0">/</span>init_resize.sh
<span class="sy0">/</span>usr<span class="sy0">/</span>bin<span class="sy0">/</span><span class="kw2">ssh-keygen</span> <span class="re5">-A</span>
&nbsp;
<span class="co0"># Reboot</span>
<span class="kw2">sync</span>
<span class="kw2">umount</span> <span class="sy0">/</span>boot
<span class="kw2">mount</span> <span class="sy0">/</span> <span class="re5">-o</span> remount,ro
<span class="kw2">sync</span>
<span class="kw3">echo</span> <span class="nu0">1</span> <span class="sy0">&gt;</span> <span class="sy0">/</span>proc<span class="sy0">/</span>sys<span class="sy0">/</span>kernel<span class="sy0">/</span>sysrq
<span class="kw3">echo</span> b <span class="sy0">&gt;</span> <span class="sy0">/</span>proc<span class="sy0">/</span>sysrq-trigger
<span class="kw2">sleep</span> <span class="nu0">5</span></pre>

</div>

<h1 class="sectionedit11" id="downgrade_or_upgrade_to_specific_kernel_version">Downgrade or Upgrade to Specific Kernel Version</h1>
<div class="level1">

<p>
Pick a commit from the <code>rpi-firmware</code> <a href="https://github.com/Hexxeh/rpi-firmware/commits/master" class="urlextern" title="https://github.com/Hexxeh/rpi-firmware/commits/master" rel="ugc nofollow">github project</a>, look at the commit hash and then issue:
</p>
<pre class="code bash">rpi-update HASH</pre>

<p>
where:
</p>
<ul>
<li class="level1"><div class="li"> <code>HASH</code> - is the commit hash</div>
</li>
</ul>

</div>

<h2 class="sectionedit12" id="downgrade_to_last_stable_firmware">Downgrade to Last Stable Firmware</h2>
<div class="level2">
<pre class="code bash"><span class="kw2">apt-get install</span> <span class="re5">--reinstall</span> raspberrypi-bootloader raspberrypi-kernel</pre>

</div>

<h1 class="sectionedit13" id="fixing_a_blinking_monitor">Fixing a Blinking Monitor</h1>
<div class="level1">

<p>
Some HDMI-to-VGA adapters that do not have their own power source draw more power from the Raspberry Pi such that sometimes the signal provided by the Raspberry Pi is insufficient. Fortunately the Raspberry Pi firmware allows to boost the signal by editing the file <code>/boot/config.txt</code> on the boot partition. Open <code>/boot/config.txt</code> and uncomment the line reading <code>config_hdmi_boost</code> and gradually increase the value until the blinking of the monitor is gone.
</p>

</div>

<h2 class="sectionedit14" id="simultaneously_playing_audio_through_headphones_analog_and_hdmi_digital">Simultaneously Playing Audio through Headphones (analog) and HDMI (digital)</h2>
<div class="level2">

<p>
Create a file at either <code>~/.asoundrc</code> or at <code>/etc/asound.conf</code> in order to play audio through both the headphone jack and the first HDMI port.
</p>
<pre class="code">###########################################################################
##  Copyright (C) Wizardry and Steamworks 2021 - License: GNU GPLv3      ##
###########################################################################
# Plays audio simultaneously through HDMI 0 an the Headphones jack on RPi #
#                                                                         #
# To use, place this file where ALSA picks up configuration files.        #
# Usually at ~/.asoundrc or /etc/asound.conf                              #
###########################################################################

pcm.both {
    type route;
    slave.pcm {
        type multi

        slaves.a.pcm &quot;hdmi:CARD=vc4hdmi0,DEV=0&quot;
        slaves.a.channels 2
        slaves.b.pcm &quot;hw:CARD=Headphones&quot;
        slaves.b.channels 2

        bindings.0.slave a
        bindings.0.channel 0
        bindings.1.slave a
        bindings.1.channel 1

        bindings.2.slave b
        bindings.2.channel 0
        bindings.3.slave b
        bindings.3.channel 1
    }

    ttable.0.0 1
    ttable.1.1 1
    ttable.0.2 1
    ttable.1.3 1
}

ctl.both {
    type hw
    card Headphones
}

pcm.stereo {
    type route
    slave.pcm &quot;both&quot;

    ttable.0.0 1
    ttable.1.1 1
    ttable.0.2 1
    ttable.1.3 1
}

pcm.!default {
    type plug
    slave {
        pcm stereo
    }
}

ctl.!default {
    type hw
    card Headphones
}
</pre>

</div>

                    <!-- wikipage stop -->
                                    </div>

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <div class="docInfo"><bdi>fuss/raspberry_pi.txt</bdi> · Last modified: 2022/04/19 09:28 (external edit)</div>

            <!-- PAGE ACTIONS -->
            <!-- <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Revisions [O]"><span>Revisions</span></a></li><li><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi?do=backlink"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi?do=export_pdf"  class="action export_pdf" rel="nofollow" title="Export to PDF"><span>Export to PDF</span></a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div>--><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer">
    <!-- <div class="buttons">
                <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://www.php.net" title="Powered by PHP" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/tpl/was/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div> -->

		<!-- BREADCRUMBS -->
					<div class="breadcrumbs">
									<div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" class="wikilink1" title="start" data-wiki-id="start">start</a></bdi></span> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss" class="wikilink1" title="fuss" data-wiki-id="fuss">fuss</a></bdi> / <bdi><a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi" class="wikilink1" title="fuss:raspberry_pi" data-wiki-id="fuss:raspberry_pi">raspberry_pi</a></bdi></div>
											</div>
		
		<!-- ********** BOTTOM BAR ********** -->
		<div class="bar" id="bar__bottom">
		  <div class="bar-left" id="bar__bottomleft">
			<form class="button btn_login" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi"><div class="no"><input type="hidden" name="do" value="login" /><input type="hidden" name="sectok" value="" /><button type="submit" title="Log In">Log In</button></div></form>						<form class="button btn_revs" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi"><div class="no"><input type="hidden" name="do" value="revisions" /><button type="submit" accesskey="o" title="Revisions [O]">Revisions</button></div></form>			                        <form class="button btn_pdf" action="?do=export_pdf" method="POST">
                            <button type="submit" title="PDF">PDF</button>
                        </form>
		  </div>
		  <div class="bar-center">
                        <form class="button btn_home" action="/" method="POST">
                            <button type="submit" title="Home">Home</button>
                        </form>
			<form action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/start" method="get" role="search" class="search doku_form" id="dw__search" accept-charset="utf-8"><input type="hidden" name="do" value="search" /><input type="hidden" name="id" value="fuss:raspberry_pi" /><div class="no"><input name="q" type="text" class="edit" title="[F]" accesskey="f" placeholder="Search" autocomplete="on" id="qsearch__in" value="" /><button value="1" type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>			<!-- <form id="osssearchform" method="get" action="renderer">
        <input type="hidden" name="use" value="grimore.org">
        <input type="hidden" name="name" value="default">
        <input type="text" id="osssearchbox" name="query">
        <input type="hidden" name="login" value="search">
        <input type="hidden" name="key" value="1a5f74ab3f4df6ce883c4c158540e25e">
        <input type="submit" value="Search">
</form>
 -->
		  </div>
		  <div class="bar-right" id="bar__bottomright">
                        <form class="button btn_contact" action="mailto:%6F%66%66%69%63%65%40%67%72%69%6D%6F%72%65%2E%6F%72%67" method="POST">
                            <button type="submit" title="Contact">Contact</button>
                        </form>
                        <form class="button btn_news" action="/feed.php?mode=recent&amp;type=rss" method="POST">
                            <button type="submit" title="News">News</button>
                        </form>
			<form class="button btn_admin" method="get" action="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/fuss/raspberry_pi"><div class="no"><input type="hidden" name="do" value="admin" /><button type="submit" title="Admin">Admin</button></div></form>								  </div>
		  		</div>

		
</div><!-- /footer -->

<div style="text-align: center;">
    <div style="display:inline-block;">
      <p>
        <a href="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion">
          <img src="/lib/tpl/was/images/button-tor.png" alt="Access website using Tor" />
        </a> 
        <a href="http://ioujrf2uwqairs7l3vyvqp7n2pia3x3wg5w5qtcqvg32zezuezza.b32.i2p/" />
          <img src="/lib/tpl/was/images/button-i2p.png" alt="Access website using i2p" />
        </a>
        <a href="http://pgp.grimore.org/" />
          <img src="/lib/tpl/was/images/button-pgp.png" alt="Wizardry and Steamworks PGP Key" />
        </a>
      </p>
    </div>
<!--    <div style="display:inline-block;">
      <p>
        <a href="http://ij4lpzuyyng6cc4jw5mxibcyjv4rx4uk6x5jijoduglkgjh7mmya.b32.i2p">
          <img src="/lib/tpl/was/images/button-i2p.png" alt="Access website using i2p" />
        </a> 
      </p>
    </div>
    <div style="display:inline-block;">
      <p>
        <a href="http://cydia.grimore.org/">
          <img src="/lib/tpl/was/images/button-cydia.png" alt="Wizardry and Steamworks Cydia Repository" />
        </a> 
      </p>
    </div>
    <div style="display:inline-block;">
      <p>
        <a href="http://debian.grimore.org/">
          <img src="/lib/tpl/was/images/button-debian.png" alt="Wizardry and Steamworks Debian Repository" />
        </a> 
      </p>
    </div>
    <div style="display:inline-block;">
      <p>
        <a href="/opt/pasteboard/" rel="external nofollow">
          <img src="/lib/tpl/was/images/button-live.png" alt="Live Pasteboard" />
        </a> 
      </p>
    </div> -->
    
<br/>

    <p>
      For the copyright, license, warranty and privacy terms for the usage of this website please see the <a
      href="/wiki:license">license</a>, <a href="/wiki:privacy">privacy</a>, <a
      href="/wiki:copyright">copyright</a>
      and the <a href="/wiki:plagiarism">plagiarism</a> pages.
    </p>
</div>
    </div></div><!-- /site -->

    <div class="no"><img src="http://3wymlmcsvxiaqzmbepsdawqpk6o2qsk65jhms72qqjulk5u4bgmvs3qd.onion/lib/exe/taskrunner.php?id=fuss%3Araspberry_pi&amp;1657306189" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div>    <!--[if lte IE 8 ]></div><![endif]-->
</body>
</html>
